<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个有思想的程序员的技术博客,Golang,Node.js,Python"><title>浅谈微信卡券功能开发（1） | LUPUB.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">浅谈微信卡券功能开发（1）</h1><a id="logo" href="/.">LUPUB.com</a><p class="description">一个有思想的程序员</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">浅谈微信卡券功能开发（1）</h1><div class="post-meta">Feb 11, 2015</div><div class="post-content"><p>由于公司的业务，有幸接触到了微信平台的开发，不得不感慨下，微信的业务规划实在是宏大的很呢。看来微信是想涉及生活的各个方面啊，再加上最近微信封杀各路豪杰（网易音乐、支付宝钱包）等，不难看出微信在产品规划上的野心。</p>
<p>貌似闲话说的太多了，接下来我就我自己对于微信卡券功能的开发经验进行简单的介绍，在微信开发的交流群中也看到很多新手开发者遇到的问题，希望本文能够帮助刚接触微信卡券的同学尽快的入门卡券功能开发，由于鄙人是NODEJS码农，<strong>所以本文主要以NODEJS为开发语言</strong>，其他语言的开发者可以飘过~或者借鉴~~</p>
<p>又一段闲话…（年纪大了，话唠了），先简单的介绍下微信卡券功能，卡券，说白了就是各种各样的优惠券，会员卡，以及各种票据等等等等，涉及的方面很广，就目前接触到的开发者来看，大多数都是对于各类优惠券的开发，其他的种类比较少了。</p>
<p>首先使用卡券功能，需要现在微信公众号平台中开启卡券功能。具体的开启步骤就不详述了，文档里面介绍的很详细（对了，附下<a href="https://mp.weixin.qq.com/zh_CN/htmledition/comm_htmledition/res/cardticket/wx_card_document.zip" target="_blank" rel="noopener">官方文档下载地址</a>），下面开始聊一聊开发步骤。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>微信提供了对于卡券的操作和管理接口，实质上<strong>就是向各个接口发送请求</strong>，最简单的，你都可以在html种建立个表单，然后填写接口需要的数据，然后POST或者GET到微信的接口地址就可以了。但是，通常我们不会这样做，因为我们的业务中可能有很多需求是微信接口无法满足的，有些信息是需要我们自己管理的。</p>
<p>在开发中，我们借助到了一个NodeJS的module，当然，大家也可以直接使用nodejs的request发送请求，但是毕竟有好多需要注意的东西，module会帮我们考虑到，我在下文也会将需要注意的地方进行说明，以便其他语言开发能够注意到。</p>
<h2 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h2><p>首先我们先通过npm安装一个module。不想使用module的同学自行略过本步骤。</p>
<p>Module为 wechat-card， 可以到 <a href="https://github.com/kenticny/wechat-card" target="_blank" rel="noopener">github</a> 上查看其相关文档，遗憾的是，这个module目前仅支持大多数的优惠券和红包，对于会员卡还有其他的门票类卡券并不支持。相信之后的版本应该会完善的，好在这些类型已经可以满足基本使用了。</p>
<pre><code>npm install wechat-card --save
</code></pre><p>ok, 完整完成后要进行一个全局的设置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wxCard = <span class="built_in">require</span>(<span class="string">"wechat-card"</span>);</span><br><span class="line"></span><br><span class="line">wxCard.setConfig(&#123;</span><br><span class="line">  appId: <span class="string">"wxXXXXXXX"</span>,</span><br><span class="line">  appSecret: <span class="string">"bulabulabulabula"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里有东西要进行说明：首先这里有两个量说明下，<code>appId</code> 和 <code>appSecret</code>，这两个量可以在微信MP平台的开发者中心中得到，他们两个虽然只是路人，但是，他们两个会创造出一个结晶，叫做 <code>access_token</code>，这个可是一个非常重要的而且脾气古怪的小朋友了。说他重要，因为他贯穿整个接口，不仅仅是卡券会用到，所以微信平台的接口都可能会使用到他；说他脾气古怪，是因为他有个特别的属性，<strong>7200秒（2小时）会过期，而且每天只能请求2000次</strong>。那么，这就要求我们要去管理 <code>access_token</code> 的生成，定时去刷新他。如果使用上述的NODEJS MODULE的话，只需要在 <code>setConfig</code> 中配置 <code>appId</code> 和 <code>appSecret</code>，Module就会自动为我们管理Token了。</p>
<p>题外话，如果我们的产品中不仅仅用到了微信卡券功能，还使用到了其他的微信功能，而这些功能中也用到了 <code>access token</code>，那么这时候就不可以将token交由某个功能区管理了，因为当一边刷新 <code>access token</code> 以后，另一边的就会失效，针对这种情况，我们应该有一个服务来为各个功能提供 <code>access token</code>，那么这里不可以配置 <code>appId</code> 和 <code>appSecret</code> 了，Module提供了另外一个配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wxCard.setConfig(&#123;</span><br><span class="line">  accessTokenService: <span class="string">"http://xxxx.xxxx.xxx/xxx"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里通过配置一个公开的服务来获取access token，需要注意的是，这里的2小时过期，以及请求次数都需要这个服务自行去管理了。</p>
<h2 id="创建门店"><a href="#创建门店" class="headerlink" title="创建门店"></a>创建门店</h2><p>我们在创建卡券之前，需要先创建门店。这里我们先解释下，门店，其实就是实际商户下的店面，举个栗子，肯德基就是一个商户，那么肯德基北京西站店就是一个门店，我们的卡券会有一个”适用门店“的选项需要对应各个门店。所以我们需要先创建各个门店以备适用。</p>
<p>查看官方文档我们可以了解到一个创建门店的接口：</p>
<pre><code>https://api.weixin.qq.com/card/location/batchadd?access_token=TOKEN
</code></pre><p>前面我们介绍了获取access token的方法，这里我们可以看到token的用途，在请求每一个接口时都需要附带token。我们可以直接向接口发送请求来完成操作。这里我们使用Module来进行创建门店：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo数据，具体的字段含义，可以参加Wechat-Card的GITHUB或者官方文档</span></span><br><span class="line"><span class="keyword">var</span> shops = [&#123;</span><br><span class="line">  <span class="string">"business_name"</span>:<span class="string">"麦当劳"</span>,</span><br><span class="line">  <span class="string">"branch_name"</span>:<span class="string">"赤岗店"</span>,</span><br><span class="line">  <span class="string">"province"</span>:<span class="string">"广东省"</span>,</span><br><span class="line">  <span class="string">"city"</span>:<span class="string">"广州市"</span>,</span><br><span class="line">  <span class="string">"district"</span>:<span class="string">"海珠区"</span>,</span><br><span class="line">  <span class="string">"address"</span>:<span class="string">"中国广东省广州市海珠区艺苑路 11 号"</span>,</span><br><span class="line">  <span class="string">"telephone"</span>:<span class="string">"020-89772059"</span>,</span><br><span class="line">  <span class="string">"category"</span>:<span class="string">"房产小区"</span>,</span><br><span class="line">  <span class="string">"longitude"</span>:<span class="string">"115.32375"</span>,</span><br><span class="line">  <span class="string">"latitude"</span>:<span class="string">"25.097486"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="string">"business_name"</span>:<span class="string">"麦当劳"</span>,</span><br><span class="line">  <span class="string">"branch_name"</span>:<span class="string">"珠江店"</span>,</span><br><span class="line">  <span class="string">"province"</span>:<span class="string">"广东省"</span>,</span><br><span class="line">  <span class="string">"city"</span>:<span class="string">"广州市"</span>,</span><br><span class="line">  <span class="string">"district"</span>:<span class="string">"海珠区"</span>,</span><br><span class="line">  <span class="string">"address"</span>:<span class="string">"中国广东省广州市海珠区艺苑路 12 号"</span>,</span><br><span class="line">  <span class="string">"telephone"</span>:<span class="string">"020-89772059"</span>,</span><br><span class="line">  <span class="string">"category"</span>:<span class="string">"房产小区"</span>,</span><br><span class="line">  <span class="string">"longitude"</span>:<span class="string">"113.32375"</span>,</span><br><span class="line">  <span class="string">"latitude"</span>:<span class="string">"23.097486"</span></span><br><span class="line">&#125;];</span><br><span class="line"> </span><br><span class="line">wxCard.shop.batchAddShops(shops, <span class="function"><span class="keyword">function</span>(<span class="params">err, ids</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这里添加成功了，ids为添加的门店的ID</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里需要说明的是：添加成功后，回到函数返回值ids为之前添加数据对应的id，<strong>如果其中有数据添加失败了，那么对应的ID为-1</strong>。</p>
<h2 id="查询门店列表"><a href="#查询门店列表" class="headerlink" title="查询门店列表"></a>查询门店列表</h2><p>和创建门店相同，我们可以获取到已经添加的门店列表。接口为：</p>
<pre><code>https://api.weixin.qq.com/card/location/batchget?access_token=TOKEN
</code></pre><p>Module中的查询方法为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 微信提供的查询方法为一种分页式的查询方法</span></span><br><span class="line"><span class="comment">// offset为起始记录的位置，count为返回数据的数量</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0</span>, count = <span class="number">10</span>;</span><br><span class="line">wxCard.shop.batchGetShops(offset, count, <span class="function"><span class="keyword">function</span>(<span class="params">err, shops</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 查询成功，shops为返回的信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里需要说明的是：微信限制了最大返回的数量为50，即count最大值为50，接口返回的字段可以参考Module文档或者官方文档。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>时间不早了，明天还得上班 -.-, 这一篇先写到这，其他的接口大家可以参照本文中介绍的方法进行尝试，方法都是大同小异的，也可以参考<a href="https://github.com/kenticny/wechat-card" target="_blank" rel="noopener">Module文档</a>，作为一个入门的经验，希望可以帮助到大家。如果其中有什么错误或者不好的地方， 希望大家能够指明，万分感谢，明晚咱们继续~~</p>
<hr>
<p>转载需经作者同意后注明作者名称和文章来源：<br><a href="https://blog.lupub.com/2015/02/11/node-js-wechat-card-01/">https://blog.lupub.com/2015/02/11/node-js-wechat-card-01/</a></p>
</div><div class="tags"><a href="/tags/Node-js/">Node.js</a><a href="/tags/Wechat/">Wechat</a><a href="/tags/Wechat-card/">Wechat card</a><a href="/tags/微信/">微信</a><a href="/tags/微信卡券/">微信卡券</a></div><div class="post-nav"><a href="/2015/02/15/node-js-wechat-card-02/" class="pre">浅谈微信卡券功能开发（2）</a><a href="/2014/10/04/chrome-extension-background-inactive/" class="next">Chrome Extension 检查视图（无效）处理方法</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/30/golang-operate-http-header-question-detail/">Golang 操作 HTTP Header 的一个小细节</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/07/compare-git-rebase-and-merge/">Git 中 rebase 和 merge 用法经验谈</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/redis-transactions-sourcecode/">从源码分析 Redis 事务原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/27/redis-transactions-basic/">浅谈 Redis 事务特性和使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/grpc-golang-practice-01/">gRPC 在 Golang 实践 - 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/12/design-pattern-chain-of-responsibiliy/">设计模式 —— 责任链模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/16/golang-concurrent-m-p-g-model/">初探 Go 语言并发 M-P-G 模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/12/node-js-wechat-card-03/">浅谈微信卡券功能开发（3）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/15/node-js-wechat-card-02/">浅谈微信卡券功能开发（2）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/11/node-js-wechat-card-01/">浅谈微信卡券功能开发（1）</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">LUPUB.com.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a99b05f84263134db717b3ff13fdaa94";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>